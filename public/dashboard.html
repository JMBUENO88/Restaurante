<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistemas DevPatec - Super Admin</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root { --patec-blue: #0d6efd; --patec-dark: #212529; --bg-light: #f4f7f9; }
        body { background-color: var(--bg-light); font-family: 'Segoe UI', sans-serif; padding-bottom: 50px; }
        
        /* Navbar */
        .navbar { background: linear-gradient(90deg, #1a252f 0%, #2c3e50 100%); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        
        /* Cards */
        .card-custom { border: none; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.05); background: white; margin-bottom: 20px; overflow: hidden; }
        .card-header-custom { background: white; padding: 20px 25px; border-bottom: 1px solid #f0f0f0; }
        
        /* Utility */
        .section-separator { border-left: 5px solid var(--patec-blue); padding-left: 15px; margin: 25px 0 15px 0; font-weight: 800; color: #495057; text-transform: uppercase; font-size: 0.85rem; }
        .table-container { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 25px rgba(0,0,0,0.05); }
        .logo-table { width: 45px; height: 45px; object-fit: contain; border-radius: 50%; border: 1px solid #dee2e6; background: #fff; padding: 2px; }
        
        /* Upload */
        .upload-area { text-align: center; padding: 15px; border: 2px dashed #dee2e6; border-radius: 10px; background: #f8f9fa; cursor: pointer; transition: 0.3s; }
        .upload-area:hover { border-color: var(--patec-blue); background: #e9ecef; }
        .logo-upload-preview { width: 100px; height: 100px; object-fit: contain; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); background: white; display: block; margin: 0 auto 10px auto; }

        /* Quick Actions Modal Styles */
        .quick-btn { transition: transform 0.2s; }
        .quick-btn:hover { transform: scale(1.05); }
        .wa-card { background-color: #dcf8c6; border: 1px solid #c9e8b0; border-radius: 10px; padding: 15px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark sticky-top p-3 mb-5">
        <div class="container-fluid">
            <span class="navbar-brand fw-bold fs-5">
                <i class="bi bi-shield-lock-fill me-2 text-warning"></i> SISTEMAS DEVPATEC
            </span>
            <div class="d-flex align-items-center">
                <div class="text-end me-3 d-none d-md-block">
                    <div class="text-light fw-bold" id="userDisplay">Cargando...</div>
                </div>
                <button onclick="logout()" class="btn btn-outline-danger btn-sm px-3"><i class="bi bi-power"></i> Salir</button>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <div class="row">
            
            <div class="col-xl-4 col-lg-5 mb-4">
                <div class="card card-custom">
                    <div class="card-header-custom"><h5 class="mb-0 fw-bold text-primary"><i class="bi bi-plus-circle-fill me-2"></i>Nueva Empresa</h5></div>
                    <div class="card-body p-4">
                        <form id="formAlta">
                            <div class="upload-area mb-4" onclick="document.getElementById('e_logo').click()">
                                <img id="previewImg" src="https://via.placeholder.com/100?text=Subir+Logo" class="logo-upload-preview">
                                <span class="small text-muted fw-bold"><i class="bi bi-cloud-upload me-1"></i> Click para subir logo</span>
                                <input type="file" id="e_logo" class="form-control d-none" accept="image/*" onchange="previewFile('e_logo','previewImg')">
                            </div>
                            <div class="section-separator">Datos del Negocio</div>
                            <div class="mb-3"><label class="small fw-bold">Nombre Comercial</label><input type="text" id="neg" class="form-control" required></div>
                            <div class="mb-3"><label class="small fw-bold">Domicilio</label><input type="text" id="neg_dir" class="form-control" required></div>
                            <div class="row g-2 mb-4">
                                <div class="col-6"><label class="small fw-bold">Tel. Fijo</label><input type="text" id="neg_tel" class="form-control"></div>
                                <div class="col-6"><label class="small fw-bold text-success">WhatsApp</label><input type="text" id="wa" class="form-control" placeholder="10 dígitos" required></div>
                            </div>
                            <div class="section-separator">Datos del Dueño</div>
                            <div class="mb-3"><label class="small fw-bold">Nombre Completo</label><input type="text" id="nom_due" class="form-control" required></div>
                            <div class="mb-3"><label class="small fw-bold">Email</label><input type="email" id="mail" class="form-control"></div>
                            <div class="mb-3"><label class="small fw-bold">Domicilio Particular</label><input type="text" id="due_dir" class="form-control"></div>
                            <div class="section-separator">Acceso y Suscripción</div>
                            <div class="bg-light p-3 rounded border mb-4">
                                <div class="row g-2 mb-3">
                                    <div class="col-6"><label class="small fw-bold text-danger">Usuario</label><input type="text" id="user" class="form-control fw-bold" required></div>
                                    <div class="col-6"><label class="small fw-bold text-danger">Contraseña</label><input type="text" id="pass" class="form-control fw-bold" required></div>
                                </div>
                                <label class="small fw-bold">Plan de Vigencia</label>
                                <div class="input-group">
                                    <select id="tipoVigencia" class="form-select" onchange="toggleDias()">
                                        <option value="30">Mensual (30 días)</option>
                                        <option value="365">Anual (365 días)</option>
                                        <option value="15">Prueba (15 días)</option>
                                        <option value="custom">Manual...</option>
                                    </select>
                                    <input type="number" id="diasN" class="form-control" value="7" style="display:none; max-width: 80px;" placeholder="Días">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 py-2 fw-bold shadow-sm" id="btnS"><i class="bi bi-save me-2"></i> REGISTRAR EMPRESA</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-xl-8 col-lg-7">
                <div class="table-container">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="mb-0 fw-bold text-dark"><i class="bi bi-building me-2 text-primary"></i>Cartera de Clientes</h5>
                        <button onclick="cargar()" class="btn btn-light border btn-sm"><i class="bi bi-arrow-clockwise me-1"></i> Actualizar</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-center">Logo</th>
                                    <th>Negocio / Contacto</th>
                                    <th>Credenciales</th>
                                    <th>Vencimiento</th>
                                    <th class="text-end">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="lista">
                                <tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p>Cargando empresas...</p></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalEdit" tabindex="-1">
        <div class="modal-dialog">
            <form id="formEdit" class="modal-content">
                <div class="modal-header bg-primary text-white"><h5 class="modal-title fw-bold">Editar Empresa</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="edit_id">
                    <div class="text-center mb-4 p-3 bg-light rounded border">
                        <img id="edit_preview" src="" class="logo-upload-preview" style="cursor: pointer;" onclick="document.getElementById('edit_file').click()">
                        <input type="file" id="edit_file" class="d-none" accept="image/*" onchange="previewFile('edit_file','edit_preview')">
                        <small class="text-muted">Click para cambiar logo</small>
                    </div>
                    <div class="mb-3"><label class="small fw-bold">Nombre Negocio</label><input type="text" id="edit_neg" class="form-control" required></div>
                    <div class="mb-3"><label class="small fw-bold">Domicilio</label><input type="text" id="edit_dir" class="form-control" required></div>
                    <div class="row g-2 mb-3">
                        <div class="col-6"><label class="small fw-bold">Tel. Fijo</label><input type="text" id="edit_tel" class="form-control"></div>
                        <div class="col-6"><label class="small fw-bold">WhatsApp</label><input type="text" id="edit_wa" class="form-control" required></div>
                    </div>
                    <div class="mb-3"><label class="small fw-bold text-danger">Vencimiento (Manual)</label><input type="date" id="edit_vence" class="form-control" required></div>
                </div>
                <div class="modal-footer"><button type="submit" class="btn btn-success fw-bold w-100">Guardar Cambios</button></div>
            </form>
        </div>
    </div>

    <div class="modal fade" id="modalQuick" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title fw-bold"><i class="bi bi-lightning-fill me-2"></i>Gestión Rápida: <span id="quickName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="quick_id">
                    <input type="hidden" id="quick_vence">
                    <input type="hidden" id="quick_tel">
                    
                    <div class="alert alert-info d-flex justify-content-between align-items-center">
                        <span><strong>Vencimiento Actual:</strong> <span id="lblVence"></span></span>
                        <span id="lblStatus"></span>
                    </div>

                    <div class="row">
                        <div class="col-md-6 border-end">
                            <h6 class="fw-bold text-primary mb-3"><i class="bi bi-calendar-plus me-2"></i>Extender Suscripción</h6>
                            
                            <button onclick="addDays(30)" class="btn btn-outline-primary w-100 mb-2 quick-btn text-start">
                                <i class="bi bi-calendar-month me-2"></i> Agregar 1 Mes (+30 días)
                            </button>
                            
                            <div class="input-group mb-2">
                                <span class="input-group-text bg-light"><i class="bi bi-gift text-danger"></i></span>
                                <select id="selPromo" class="form-select">
                                    <option value="5">Promo 5 Días</option>
                                    <option value="10">Promo 10 Días</option>
                                    <option value="15">Promo 15 Días (2+ Meses)</option>
                                    <option value="20">Promo 20 Días</option>
                                    <option value="25">Promo 25 Días</option>
                                    <option value="30">Promo 30 Días</option>
                                </select>
                                <button onclick="addPromo()" class="btn btn-success">Aplicar</button>
                            </div>

                            <label class="small text-muted mt-2">Prueba / Manual</label>
                            <div class="input-group">
                                <input type="number" id="manualDays" class="form-control" placeholder="Días">
                                <button onclick="addManual()" class="btn btn-dark">Agregar</button>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h6 class="fw-bold text-success mb-3"><i class="bi bi-whatsapp me-2"></i>Centro de Mensajes</h6>
                            
                            <div class="wa-card mb-3">
                                <label class="small fw-bold mb-1">Recordatorio de Pago</label>
                                <p class="small text-muted lh-1 mb-2">"Tu suscripción vence en X días..."</p>
                                <button onclick="sendReminder()" class="btn btn-success btn-sm w-100"><i class="bi bi-send me-1"></i> Enviar Recordatorio</button>
                            </div>

                            <label class="small fw-bold">Mensaje Personalizado</label>
                            <textarea id="txtCustomWA" class="form-control mb-2" rows="3" placeholder="Escribe tu promoción aquí..."></textarea>
                            <button onclick="sendCustomWA()" class="btn btn-outline-success btn-sm w-100"><i class="bi bi-send me-1"></i> Enviar Mensaje</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'
        import { SUPABASE_URL, SUPABASE_KEY } from './config.js';
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- INICIALIZACIÓN SEGURA ---
        window.onload = () => {
            const user = localStorage.getItem('usuario_actual');
            const rol = localStorage.getItem('rol');
            
            if(rol !== 'super_admin') { window.location.href = 'index.html'; return; }
            document.getElementById('userDisplay').innerText = `Admin: ${user}`;
            
            // CARGA FORZADA AL INICIO
            cargar();
        };

        window.previewFile = (inputId, imgId) => {
            const file = document.getElementById(inputId).files[0];
            if(file){ const r = new FileReader(); r.onload=(e)=>document.getElementById(imgId).src=e.target.result; r.readAsDataURL(file); }
        };
        window.toggleDias = () => { document.getElementById('diasN').style.display = (document.getElementById('tipoVigencia').value === 'custom' ? 'block' : 'none'); };
        window.logout = () => { localStorage.clear(); window.location.href = 'index.html'; };

        // --- CARGA DE DATOS ---
        window.cargar = async () => {
            const list = document.getElementById('lista');

            const { data: emps } = await supabase.from('empresas').select('*').order('created_at', {ascending: false});
            const { data: usrs } = await supabase.from('usuarios').select('*').eq('rol', 'dueno');

            list.innerHTML = '';
            if(!emps || emps.length === 0) {
                list.innerHTML = '<tr><td colspan="5" class="text-center">No hay empresas registradas</td></tr>';
                return;
            }

            emps.forEach(e => {
                const u = usrs?.find(x => x.empresa_id === e.id);
                const hoy = new Date();
                const venci = new Date(e.fecha_vencimiento);
                const diff = Math.ceil((venci - hoy) / (1000 * 60 * 60 * 24));
                
                let badge = '';
                if (diff < 0) badge = `<span class="badge bg-danger">Vencido (${Math.abs(diff)} días)</span>`;
                else if (diff <= 5) badge = `<span class="badge bg-warning text-dark">Vence en ${diff} días</span>`;
                else badge = `<span class="badge bg-success">Activo (${diff} días)</span>`;

                const logo = e.logo_url || 'https://via.placeholder.com/40?text=S/L';

                list.innerHTML += `
                    <tr>
                        <td class="text-center"><img src="${logo}" class="logo-table"></td>
                        <td>
                            <div class="fw-bold text-primary">${e.nombre_negocio}</div>
                            <div class="small text-muted"><i class="bi bi-geo-alt"></i> ${e.domicilio_negocio}</div>
                            <div class="small text-muted"><i class="bi bi-telephone"></i> ${e.telefono_comercial || '--'}</div>
                        </td>
                        <td>
                            <div class="small fw-bold">${u?.username || '---'}</div>
                            <div class="small text-muted">Pass: ${u?.password || '***'}</div>
                        </td>
                        <td>
                            ${badge}
                            <div class="small text-muted mt-1" style="font-size:0.75rem">Exp: ${e.fecha_vencimiento}</div>
                        </td>
                        <td class="text-end">
                            <button class="btn btn-warning btn-sm me-1 shadow-sm" onclick='openQuick(${JSON.stringify(e)})' title="Acciones Rápidas">
                                <i class="bi bi-lightning-fill text-dark"></i>
                            </button>
                            <button class="btn btn-outline-primary btn-sm me-1" onclick='abrirEditar(${JSON.stringify(e)})' title="Editar Completo">
                                <i class="bi bi-pencil-fill"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="eliminar('${e.id}')" title="Borrar">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </td>
                    </tr>`;
            });
        };

        // --- ALTA EMPRESA ---
        document.getElementById('formAlta').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnS'); btn.disabled=true; btn.innerText="Guardando...";
            try {
                const file = document.getElementById('e_logo').files[0];
                let logoUrl = null;
                if(file) {
                    const fName = `logos/${Date.now()}_${file.name}`;
                    await supabase.storage.from('imagenes').upload(fName, file);
                    const { data } = supabase.storage.from('imagenes').getPublicUrl(fName);
                    logoUrl = data.publicUrl;
                }

                let dias = document.getElementById('tipoVigencia').value;
                if(dias==='custom') dias = document.getElementById('diasN').value;
                const fV = new Date(); fV.setDate(fV.getDate() + parseInt(dias));

                const { data: nEmp, error: er1 } = await supabase.from('empresas').insert([{
                    nombre_negocio: document.getElementById('neg').value,
                    domicilio_negocio: document.getElementById('neg_dir').value,
                    telefono_comercial: document.getElementById('neg_tel').value,
                    telefono: "52" + document.getElementById('wa').value,
                    fecha_vencimiento: fV.toISOString().split('T')[0],
                    logo_url: logoUrl
                }]).select().single();
                if(er1) throw er1;

                const { error: er2 } = await supabase.from('usuarios').insert([{
                    empresa_id: nEmp.id,
                    username: document.getElementById('user').value,
                    password: document.getElementById('pass').value,
                    nombre_completo: document.getElementById('nom_due').value,
                    domicilio_particular: document.getElementById('due_dir').value,
                    email_personal: document.getElementById('mail').value,
                    rol: 'dueno'
                }]);
                if (er2) throw er2;

                Swal.fire('Éxito','Empresa creada','success');
                e.target.reset(); document.getElementById('previewImg').src='https://via.placeholder.com/100?text=Subir';
                cargar();

            } catch(err){ 
                // DETECCIÓN DE USUARIO DUPLICADO
                if(err.code === '23505' || err.message.includes('duplicate')) {
                    Swal.fire('Usuario Ocupado', 'Ese nombre de usuario ya existe. Intenta con otro.', 'warning');
                } else {
                    Swal.fire('Error',err.message,'error'); 
                }
            } finally{ btn.disabled=false; btn.innerHTML='<i class="bi bi-save me-2"></i> REGISTRAR EMPRESA'; }
        };

        // --- ACCIONES RÁPIDAS (RAYO) ---
        window.openQuick = (emp) => {
            document.getElementById('quickName').innerText = emp.nombre_negocio;
            document.getElementById('quick_id').value = emp.id;
            document.getElementById('quick_vence').value = emp.fecha_vencimiento;
            document.getElementById('quick_tel').value = emp.telefono;
            document.getElementById('lblVence').innerText = emp.fecha_vencimiento;
            
            // Estado visual
            const hoy = new Date(); const venci = new Date(emp.fecha_vencimiento);
            if(venci < hoy) document.getElementById('lblStatus').innerHTML = '<span class="badge bg-danger">Vencida</span>';
            else document.getElementById('lblStatus').innerHTML = '<span class="badge bg-success">Activa</span>';

            new bootstrap.Modal(document.getElementById('modalQuick')).show();
        };

        // Lógica de fechas inteligente
        window.addDays = async (dias) => { await procesarExtension(parseInt(dias)); };
        window.addPromo = async () => { await procesarExtension(parseInt(document.getElementById('selPromo').value)); };
        window.addManual = async () => { 
            const d = document.getElementById('manualDays').value; 
            if(!d) return; 
            await procesarExtension(parseInt(d)); 
        };

        async function procesarExtension(dias) {
            const id = document.getElementById('quick_id').value;
            const fechaActualStr = document.getElementById('quick_vence').value;
            
            // Calculo inteligente: Si ya venció, sumamos a partir de HOY. Si no, sumamos a partir de SU FECHA.
            const hoy = new Date();
            const vencimientoActual = new Date(fechaActualStr);
            let baseDate = (vencimientoActual > hoy) ? vencimientoActual : hoy;
            
            baseDate.setDate(baseDate.getDate() + dias);
            const nuevaFecha = baseDate.toISOString().split('T')[0];

            const { error } = await supabase.from('empresas').update({ fecha_vencimiento: nuevaFecha }).eq('id', id);
            
            if(error) {
                Swal.fire('Error', error.message, 'error');
            } else {
                Swal.fire({ title: '¡Actualizado!', text: `Nueva fecha: ${nuevaFecha}`, icon: 'success', timer: 1500 });
                cargar(); // Recargar tabla
                bootstrap.Modal.getInstance(document.getElementById('modalQuick')).hide();
            }
        }

        // --- WHATSAPP LOGIC ---
        window.sendReminder = () => {
            const tel = document.getElementById('quick_tel').value;
            const fecha = document.getElementById('quick_vence').value;
            const hoy = new Date(); const venci = new Date(fecha);
            const diff = Math.ceil((venci - hoy) / (1000 * 60 * 60 * 24));
            
            let msg = '';
            if(diff < 0) msg = `Hola! Tu suscripción a Sistemas DevPatec venció hace ${Math.abs(diff)} días. Te invitamos a renovar para seguir disfrutando del servicio.`;
            else msg = `Hola! Te recordamos que tu suscripción a Sistemas DevPatec vence en ${diff} días (${fecha}).`;

            window.open(`https://wa.me/${tel}?text=${encodeURIComponent(msg)}`, '_blank');
        };

        window.sendCustomWA = () => {
            const tel = document.getElementById('quick_tel').value;
            const txt = document.getElementById('txtCustomWA').value;
            if(!txt) return Swal.fire('Escribe algo', '', 'warning');
            window.open(`https://wa.me/${tel}?text=${encodeURIComponent(txt)}`, '_blank');
        };

        // --- EDICIÓN COMPLETA Y ELIMINAR ---
        window.abrirEditar = (e) => {
            document.getElementById('edit_id').value = e.id;
            document.getElementById('edit_neg').value = e.nombre_negocio;
            document.getElementById('edit_dir').value = e.domicilio_negocio;
            document.getElementById('edit_tel').value = e.telefono_comercial;
            document.getElementById('edit_wa').value = e.telefono ? e.telefono.replace(/^52/, '') : '';
            document.getElementById('edit_vence').value = e.fecha_vencimiento;
            document.getElementById('edit_preview').src = e.logo_url || 'https://via.placeholder.com/100?text=Logo';
            new bootstrap.Modal(document.getElementById('modalEdit')).show();
        };

        document.getElementById('formEdit').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit_id').value;
            try {
                let up = {
                    nombre_negocio: document.getElementById('edit_neg').value,
                    domicilio_negocio: document.getElementById('edit_dir').value,
                    telefono_comercial: document.getElementById('edit_tel').value,
                    telefono: "52" + document.getElementById('edit_wa').value,
                    fecha_vencimiento: document.getElementById('edit_vence').value
                };
                const file = document.getElementById('edit_file').files[0];
                if(file) {
                    const f = `logos/${Date.now()}_${file.name}`;
                    await supabase.storage.from('imagenes').upload(f, file);
                    const { data } = supabase.storage.from('imagenes').getPublicUrl(f);
                    up.logo_url = data.publicUrl;
                }
                await supabase.from('empresas').update(up).eq('id', id);
                Swal.fire('Editado', '', 'success');
                cargar();
                bootstrap.Modal.getInstance(document.getElementById('modalEdit')).hide();
            } catch(err) { Swal.fire('Error', err.message, 'error'); }
        };

        window.eliminar = async (id) => {
            if((await Swal.fire({title:'¿Borrar?', text:'Se perderá todo.', icon:'warning', showCancelButton:true})).isConfirmed) {
                await supabase.from('empresas').delete().eq('id', id);
                cargar();
            }
        };

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>